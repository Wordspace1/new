<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#000000">
    <title>Nika123 Cloud Optimized</title>
    <style>
        /* --- 1. CORE VARIABLES & RESET --- */
        :root {
            --bg-dark: #000000;
            --bg-card: #121212;
            --text-main: #ffffff;
            --text-muted: #a0a0a0;
            --primary: #0095f6;
            --primary-grad: linear-gradient(45deg, #00c6ff, #0072ff);
            --border: #262626;
            --glass: rgba(22, 22, 22, 0.85);
            --msg-me: #0095f6;
            --msg-other: #2c2c2c;
        }
        
        * { margin: 0; padding: 0; box-sizing: border-box; -webkit-tap-highlight-color: transparent; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; }
        body { background-color: var(--bg-dark); color: var(--text-main); padding-bottom: 80px; overflow-x: hidden; height: 100vh; }
        ::-webkit-scrollbar { width: 0px; background: transparent; }

        /* --- 2. LOGIN SCREEN --- */
        #login-screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-dark); z-index: 3000; display: flex; justify-content: center; align-items: center; background-image: radial-gradient(circle at 50% 50%, #1a1a1a 0%, #000000 100%); }
        .login-card { background: var(--bg-card); padding: 40px 30px; border-radius: 24px; width: 85%; max-width: 350px; text-align: center; border: 1px solid var(--border); box-shadow: 0 20px 50px rgba(0,0,0,0.5); animation: fadeInUp 0.5s ease-out; }
        .login-logo { width: 80px; height: 80px; border-radius: 50%; margin: 0 auto 20px; background: var(--primary-grad); display: flex; align-items: center; justify-content: center; font-size: 40px; box-shadow: 0 0 20px rgba(0, 149, 246, 0.4); }
        .login-card h2 { margin-bottom: 10px; font-size: 22px; letter-spacing: -0.5px; }
        .login-card p { color: var(--text-muted); font-size: 13px; margin-bottom: 25px; }
        .input-box { width: 100%; padding: 14px; margin-bottom: 12px; background: #1e1e1e; border: 1px solid var(--border); border-radius: 12px; font-size: 15px; color: white; outline: none; transition: 0.3s; }
        .input-box:focus { border-color: var(--primary); background: #252525; }
        .btn-login { width: 100%; padding: 14px; background: var(--primary-grad); color: white; border: none; border-radius: 12px; font-weight: 600; font-size: 16px; cursor: pointer; box-shadow: 0 4px 15px rgba(0, 149, 246, 0.3); margin-top: 10px; }

        /* --- 3. APP CONTAINER --- */
        #app-container { display: none; animation: fadeIn 0.5s ease; }
        .profile-header { background: var(--bg-card); padding: 30px 20px; border-bottom: 1px solid var(--border); display: flex; flex-direction: column; gap: 25px; }
        .profile-top { display: flex; align-items: center; gap: 20px; }
        .avatar-container { position: relative; width: 90px; height: 90px; }
        .avatar { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; border: 3px solid var(--bg-dark); box-shadow: 0 0 0 2px var(--primary); }
        .profile-info { flex: 1; }
        .username-row { display: flex; align-items: center; gap: 10px; margin-bottom: 8px; }
        .username-row h3 { font-size: 22px; font-weight: 700; letter-spacing: -0.5px; }
        .btn-saldo { background: rgba(16, 185, 129, 0.15); color: #10b981; border: 1px solid rgba(16, 185, 129, 0.3); padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: 600; display: inline-flex; align-items: center; gap: 5px; }
        
        .header-controls { position: absolute; top: 20px; right: 20px; display: flex; gap: 8px; }
        .icon-btn { background: rgba(255,255,255,0.1); border: none; color: white; width: 32px; height: 32px; border-radius: 50%; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 14px; transition: 0.2s; }
        .icon-btn:active { background: var(--primary); }
        .sync-status { font-size: 10px; color: var(--text-muted); display: flex; align-items: center; gap: 5px; padding: 5px 10px; background: rgba(255,255,255,0.05); border-radius: 20px; }
        .dot { width: 8px; height: 8px; border-radius: 50%; background: #555; box-shadow: 0 0 5px #555; }
        .dot.online { background: var(--success); box-shadow: 0 0 8px var(--success); }
        .dot.spin { animation: spin 1s linear infinite; background: #fbbf24; }
        .dot.update { background: #00c6ff; box-shadow: 0 0 8px #00c6ff; animation: pulse 1s infinite; }

        .stats-row { display: flex; justify-content: space-around; text-align: center; margin-top: 10px; }
        .stat-num { font-weight: 700; font-size: 19px; display: block; }
        .stat-label { font-size: 12px; color: var(--text-muted); font-weight: 500; }
        .bio-section { text-align: center; }
        .bio-section h2 { font-size: 18px; font-weight: 600; margin-bottom: 5px; }
        .bio-section p { font-size: 14px; color: #d1d1d1; line-height: 1.4; }
        .btn-edit { width: 100%; margin-top: 15px; padding: 8px; background: transparent; border: 1px solid var(--border); color: white; border-radius: 8px; font-weight: 600; font-size: 14px; transition: 0.2s; }
        .btn-edit:active { background: var(--border); }

        /* --- FEED GRID --- */
        .feed { display: flex; flex-wrap: wrap; padding: 1px; }
        .post-card { width: 33.33%; padding: 1px; box-sizing: border-box; position: relative; background: #000; aspect-ratio: 1/1; overflow: hidden; cursor: pointer; }
        .post-card video, .post-card img { width: 100%; height: 100%; object-fit: cover; transition: 0.3s; }
        .post-card:active img { transform: scale(0.95); }
        .post-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); color: white; display: flex; align-items: center; justify-content: center; opacity: 0; transition: 0.2s; backdrop-filter: blur(2px); }
        .post-card:hover .post-overlay { opacity: 1; }

        /* --- 4. CHAT INTERFACE --- */
        #chat-view { display: none; flex-direction: column; height: calc(100vh - 60px); }
        .chat-container { flex: 1; overflow-y: auto; padding: 20px; display: flex; flex-direction: column; gap: 15px; }
        .chat-bubble { max-width: 75%; padding: 10px 15px; border-radius: 18px; position: relative; font-size: 14px; line-height: 1.4; animation: popIn 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .chat-bubble.me { align-self: flex-end; background: var(--msg-me); color: white; border-bottom-right-radius: 4px; }
        .chat-bubble.other { align-self: flex-start; background: var(--msg-other); color: white; border-bottom-left-radius: 4px; }
        .chat-sender-name { font-size: 10px; opacity: 0.7; margin-bottom: 3px; display: block; font-weight: 600; }
        .chat-time { font-size: 9px; opacity: 0.6; display: block; text-align: right; margin-top: 5px; }
        .chat-input-area { background: var(--bg-card); padding: 10px 15px; border-top: 1px solid var(--border); display: flex; align-items: center; gap: 10px; position: fixed; bottom: 60px; left: 0; width: 100%; z-index: 95; }
        .chat-input { flex: 1; background: #1e1e1e; border: 1px solid var(--border); border-radius: 20px; padding: 10px 15px; color: white; outline: none; font-size: 14px; }
        .chat-input:focus { border-color: var(--primary); }
        .btn-send { background: var(--primary); color: white; border: none; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 2px 10px rgba(0,0,0,0.3); }

        /* --- 5. BOTTOM NAVIGATION --- */
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: var(--glass); backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px); border-top: 1px solid var(--border); display: flex; justify-content: space-around; align-items: center; padding: 12px 0; z-index: 100; }
        .nav-item { color: var(--text-muted); font-size: 24px; cursor: pointer; transition: 0.3s; position: relative; }
        .nav-item.active { color: white; transform: translateY(-2px); }
        .nav-item.active::after { content: ''; position: absolute; bottom: -5px; left: 50%; transform: translateX(-50%); width: 5px; height: 5px; background: white; border-radius: 50%; }

        /* --- 6. MODALS --- */
        .modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); z-index: 200; display: none; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
        .modal-content { background: #1e1e1e; width: 90%; max-width: 400px; border-radius: 20px; overflow: hidden; box-shadow: 0 25px 50px -12px rgba(0,0,0,0.5); border: 1px solid var(--border); animation: popUp 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .edit-header { padding: 20px; text-align: center; font-weight: 700; font-size: 16px; border-bottom: 1px solid var(--border); position: relative; background: #252525; }
        .btn-nav-close { position: absolute; left: 15px; top: 20px; font-size: 16px; color: var(--primary); background: none; border: none; font-weight: 600; cursor: pointer; }
        .btn-nav-save { position: absolute; right: 15px; top: 20px; font-size: 16px; color: var(--primary); background: none; border: none; font-weight: 600; cursor: pointer; }
        .edit-body { padding: 25px; background: #1e1e1e; }
        .form-group { margin-bottom: 20px; }
        .form-label { font-size: 12px; font-weight: 600; color: var(--text-muted); margin-bottom: 8px; display: block; text-transform: uppercase; letter-spacing: 0.5px;}
        .form-input { width: 100%; padding: 12px; border: 1px solid var(--border); border-radius: 10px; background: #121212; font-size: 14px; color: white; outline: none; }
        .form-input:focus { border-color: var(--primary); }
        .btn-action { width: 100%; padding: 14px; background: var(--primary-grad); color: white; border: none; border-radius: 12px; font-weight: 600; font-size: 15px; cursor: pointer; box-shadow: 0 4px 15px rgba(0, 149, 246, 0.3); }

        .fab { position: fixed; bottom: 85px; right: 20px; width: 56px; height: 56px; background: var(--primary-grad); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 28px; box-shadow: 0 10px 30px rgba(0, 149, 246, 0.4); cursor: pointer; z-index: 90; border: 2px solid #121212; }

        @keyframes fadeInUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes popUp { from { transform: scale(0.8); opacity: 0; } to { transform: scale(1); opacity: 1; } }
        @keyframes popIn { from { opacity: 0; transform: scale(0.8); } to { opacity: 1; transform: scale(1); } }
        @keyframes spin { 100% { transform: rotate(360deg); } }
        @keyframes pulse { 0% { opacity: 0.6; } 50% { opacity: 1; } 100% { opacity: 0.6; } }

        .saldo-card { background: linear-gradient(135deg, #11998e, #38ef7d); padding: 25px; border-radius: 16px; text-align: center; margin-bottom: 25px; color: white; box-shadow: 0 10px 20px rgba(16, 185, 129, 0.2); }
        .saldo-big { font-size: 28px; font-weight: 800; margin-top: 5px; }

        .hidden { display: none !important; }
        textarea.form-input { resize: none; height: 80px; }
        select.form-input { appearance: none; background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%23a0a0a0%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E"); background-repeat: no-repeat; background-position: right 12px top 50%; background-size: 10px auto; }
    </style>
</head>
<body>

    <!-- 1. LOGIN SCREEN -->
    <div id="login-screen">
        <div class="login-card">
            <div class="login-logo">N</div>
            <h2>Selamat Datang</h2>
            <p>Login ke akun Nika123</p>
            <input type="text" id="username" class="input-box" placeholder="Username (nika123)">
            <input type="password" id="code" class="input-box" placeholder="Kode (333)">
            <button class="btn-login" onclick="attemptLogin()">Masuk Aplikasi</button>
            <div style="margin-top: 20px; font-size: 11px; color: #555;">Smart Compressor Active</div>
        </div>
    </div>

    <!-- 2. PROFILE & POST APP -->
    <div id="app-container">
        
        <div class="profile-header">
            <div class="header-controls">
                <div class="sync-status" onclick="openSettingsModal()">
                    <div class="dot" id="sync-dot"></div>
                    <span id="sync-text">Connecting...</span>
                </div>
                <button class="icon-btn" onclick="manualRefresh()" title="Cek Update Baru">üîÑ</button>
            </div>

            <div class="profile-top">
                <div class="avatar-container">
                    <img src="https://ui-avatars.com/api/?name=Nika+123&background=random&size=200" class="avatar" id="main-avatar">
                </div>
                <div class="profile-info">
                    <div class="username-row">
                        <h3 id="display-name">Nika Keren ‚úì</h3>
                    </div>
                    <button class="btn-saldo" onclick="openSaldoModal()">
                        <span>üí∞</span> Rp <span id="saldo-display">0</span>
                    </button>
                </div>
            </div>

            <div class="stats-row">
                <span><span class="stat-num" id="post-count">0</span> <span class="stat-label">Posts</span></span>
                <span><span class="stat-num">101K</span> <span class="stat-label">Followers</span></span>
                <span><span class="stat-num">0</span> <span class="stat-label">Following</span></span>
            </div>

            <div class="bio-section">
                <p id="display-bio">üåü Simple | 100k Fam</p>
                <button class="btn-edit" onclick="openEditModal()">Edit Profile</button>
            </div>
        </div>

        <!-- Feed Area -->
        <div class="feed" id="feed-container">
            <div style="width:100%; text-align:center; padding: 60px 20px; color: #555;">
                <div style="font-size: 40px; margin-bottom: 10px;">üì∑</div>
                Belum ada postingan.
            </div>
        </div>

        <div class="fab" onclick="openUploadModal()">+</div>
    </div>

    <!-- 3. CHAT INTERFACE -->
    <div id="chat-view">
        <div class="chat-container" id="chat-messages">
            <div style="text-align:center; color: #555; margin-top: 50px; font-size: 12px;">Belum ada percakapan.</div>
        </div>
        <div class="chat-input-area">
            <input type="text" id="msg-input" class="chat-input" placeholder="Tulis pesan..." autocomplete="off">
            <button class="btn-send" onclick="sendMessage()">‚û§</button>
        </div>
    </div>

    <!-- Bottom Navigation -->
    <div class="bottom-nav">
        <div class="nav-item active" onclick="switchTab(this, 'posts')">üè†</div>
        <div class="nav-item" onclick="switchTab(this, 'chat')">üí¨</div>
        <div class="nav-item" onclick="switchTab(this, 'settings')">‚öôÔ∏è</div>
    </div>

    <!-- MODALS -->
    <div class="modal" id="saldo-modal">
        <div class="modal-content">
            <div class="edit-header"><button class="btn-nav-close" onclick="closeSaldoModal()">Batal</button><span>Penarikan Dana</span><span></span></div>
            <div class="edit-body">
                <div class="saldo-card"><div style="font-size: 12px; opacity: 0.9; text-transform: uppercase;">Saldo Tersedia</div><div class="saldo-big">Rp <span id="modal-saldo-display">0</span></div></div>
                <div class="form-group"><label class="form-label">Jumlah (Rp)</label><input type="number" id="tarik-jumlah" class="form-input" placeholder="50000"></div>
                <div class="form-group"><label class="form-label">Nomor Dana</label><input type="number" id="tarik-dana" class="form-input" placeholder="08xxxxxxxxxx"></div>
                <div class="form-group"><label class="form-label">Nama Penerima</label><input type="text" id="tarik-nama" class="form-input" placeholder="Nama Lengkap"></div>
                <button class="btn-action" id="btn-tarik-act" onclick="prosesTarik()">Tarik Sekarang</button>
                <div id="padding-text" style="margin-top:15px; color:#888; font-size:12px; display:none; text-align:center;">Memproses...</div>
                <div id="qr-container" style="display:none; text-align:center; margin-top:20px;"><img id="qr-image" src="" style="width:150px; height:150px; border-radius:10px;"></div>
            </div>
        </div>
    </div>

    <div class="modal" id="edit-modal">
        <div class="modal-content">
            <div class="edit-header"><button class="btn-nav-close" onclick="closeEditModal()">Batal</button><span>Edit Profil</span><button class="btn-nav-save" onclick="saveProfile()">Simpan</button></div>
            <div class="edit-body" style="text-align: center;">
                <img src="" id="edit-avatar-preview" class="avatar" style="width:100px; height:100px; margin:0 auto 15px; border:2px solid var(--border);">
                <div style="margin-bottom: 20px;"><label for="edit-pp-file" style="color: var(--primary); font-weight: 600; font-size: 14px; cursor: pointer;">Ubah Foto Profil</label><input type="file" id="edit-pp-file" accept="image/*" style="display: none;" onchange="previewPP(this)"></div>
                <div class="form-group"><label class="form-label">Nama</label><input type="text" id="edit-name-input" class="form-input" value=""></div>
                <div class="form-group"><label class="form-label">Bio</label><textarea id="edit-bio-input" class="form-input" rows="3"></textarea></div>
            </div>
        </div>
    </div>

    <div class="modal" id="upload-modal">
        <div class="modal-content">
            <div class="edit-header"><button class="btn-nav-close" onclick="closeUploadModal()">Batal</button><span>Buat Postingan</span><span></span></div>
            <div class="edit-body" style="display:flex; flex-direction:column; gap:15px;">
                <input type="text" id="caption-input" class="form-input" placeholder="Caption...">
                <div class="form-group"><label class="form-label">Tipe Media</label><select id="type-select" class="form-input" onchange="toggleFileInput()"><option value="photo">üì∑ Foto</option><option value="video">üé• Video</option><option value="voice">üé§ Suara</option></select></div>
                <div style="background: #121212; padding: 20px; border: 2px dashed var(--border); border-radius: 12px; text-align:center;"><input type="file" id="file-input" style="width:100%; color: #a0a0a0;" accept="image/*"></div>
                <button class="btn-action" onclick="uploadPost()">Posting Sekarang</button>
            </div>
        </div>
    </div>

    <div class="modal" id="view-modal">
        <div class="modal-content" style="max-width: 600px; background: #000;">
            <div class="edit-header" style="background: transparent; border: none;"><span style="margin-left: 10px;">@nika123</span><button class="btn-nav-close" onclick="document.getElementById('view-modal').style.display='none'" style="right: 15px; top: 15px;">‚úï</button></div>
            <div class="modal-body" id="view-media-container" style="padding:0; background: #000;"></div>
            <div style="padding: 15px;"><p><span style="font-weight: 700;">nika123</span> <span id="view-caption"></span></p><p style="color: var(--text-muted); font-size: 11px; margin-top: 5px;">JUST NOW</p></div>
        </div>
    </div>

    <div class="modal" id="settings-modal">
        <div class="modal-content">
            <div class="edit-header"><span>Pengaturan Cloud</span><button class="btn-nav-close" onclick="closeSettingsModal()">‚úï</button></div>
            <div class="edit-body">
                <p style="font-size:13px; color:#888; margin-bottom:20px;">Masukkan kode JSONBin.io.</p>
                <div class="form-group"><label class="form-label">Bin ID</label><input type="text" id="cloud-bin-id" class="form-input" placeholder="694f..."></div>
                <div class="form-group"><label class="form-label">Master Key</label><input type="password" id="cloud-api-key" class="form-input" placeholder="$2a$10..."></div>
                <button class="btn-action" onclick="saveCloudSettings()">Simpan & Koneksi</button>
            </div>
        </div>
    </div>

<script>
    // --- DATA & STATE ---
    let appData = {
        profile: { name: "Nika Keren ‚úì", bio: "üåü Simple | 100k Fam", avatar: "https://ui-avatars.com/api/?name=Nika+123&background=random&size=200" },
        posts: [],
        saldo: 112000,
        messages: []
    };
    let cloudConfig = { binId: localStorage.getItem('nika_cloud_id') || "", apiKey: localStorage.getItem('nika_cloud_key') || "" };
    const formatNumber = (num) => new Intl.NumberFormat('id-ID').format(num);

    // --- SMART COMPRESSOR (MENGECELIKAN FOTO AGAR MUAT DI CLOUD) ---
    function compressImage(file, maxWidth = 600, quality = 0.6) {
        return new Promise((resolve) => {
            const reader = new FileReader();
            reader.readAsDataURL(file);
            reader.onload = (event) => {
                const img = new Image();
                img.src = event.target.result;
                img.onload = () => {
                    let width = img.width;
                    let height = img.height;
                    
                    // Resize jika terlalu lebar
                    if (width > maxWidth) {
                        height *= maxWidth / width;
                        width = maxWidth;
                    }

                    const canvas = document.createElement('canvas');
                    canvas.width = width;
                    canvas.height = height;
                    const ctx = canvas.getContext('2d');
                    ctx.drawImage(img, 0, 0, width, height);
                    
                    // Convert ke JPEG berkualitas rendah (menghemat space)
                    resolve(canvas.toDataURL('image/jpeg', quality));
                }
            }
        });
    }

    // --- CLOUD SYNC & AUTO REFRESH ---
    let refreshInterval;

    async function fetchFromCloud() {
        if (!cloudConfig.binId || !cloudConfig.apiKey) return false;
        try {
            const isManual = arguments[0]; 
            if(isManual) updateSyncStatus('loading');

            const response = await fetch(`https://api.jsonbin.io/v3/b/${cloudConfig.binId}/latest`, { headers: { 'X-Master-Key': cloudConfig.apiKey } });
            if (!response.ok) throw new Error('Error');
            const dataWrapper = await response.json();
            const newData = dataWrapper.record;

            if(!newData.messages) newData.messages = [];

            // Hapus postingan lama jika sudah terlalu banyak (agar penuh storage)
            if(newData.posts && newData.posts.length > 20) {
                newData.posts = newData.posts.slice(0, 15); // Keep only 15
                // Auto save trimmed data silently
                // fetch(..., {method: 'PUT', body: JSON.stringify(newData)...}) 
            }

            appData = newData;

            if(isManual) {
                updateSyncStatus('online');
                alert("Data diperbarui!");
            } else {
                updateSyncStatus('online');
            }
            return true;
        } catch (e) { 
            if(arguments[0]) { alert("Gagal update! Cek koneksi."); updateSyncStatus('offline'); } 
            return false; 
        }
    }

    async function saveToCloud() {
        if (!cloudConfig.binId || !cloudConfig.apiKey) return;
        try {
            updateSyncStatus('loading');
            await fetch(`https://api.jsonbin.io/v3/b/${cloudConfig.binId}`, {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json', 'X-Master-Key': cloudConfig.apiKey },
                body: JSON.stringify(appData)
            });
            updateSyncStatus('online');
        } catch (e) { updateSyncStatus('offline'); alert("Gagal menyimpan ke Cloud! Data terlalu penuh."); }
    }

    function updateSyncStatus(status) {
        const dot = document.getElementById('sync-dot');
        const text = document.getElementById('sync-text');
        if (status === 'loading') { dot.className = 'dot spin'; text.innerText = 'Sync...'; }
        else if (status === 'online') { dot.className = 'dot online'; text.innerText = 'Online'; }
        else { dot.className = 'dot'; text.innerText = 'Offline'; }
    }

    function startAutoRefresh() {
        if(refreshInterval) clearInterval(refreshInterval);
        refreshInterval = setInterval(() => { fetchFromCloud(false); }, 10000);
    }

    function manualRefresh() { fetchFromCloud(true); }

    // --- LOAD & INIT ---
    async function loadData() {
        let isCloud = false;
        if (cloudConfig.binId && cloudConfig.apiKey) isCloud = await fetchFromCloud(true);
        
        document.getElementById('display-name').innerText = appData.profile.name;
        document.getElementById('display-bio').innerText = appData.profile.bio;
        document.getElementById('main-avatar').src = appData.profile.avatar;
        renderFeed();
        document.getElementById('post-count').innerText = appData.posts.length;
        updateSaldoDisplay();
        startAutoRefresh();
    }

    async function attemptLogin() {
        const u = document.getElementById('username').value;
        const c = document.getElementById('code').value;
        if (u === 'nika123' && c === '333') {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('app-container').style.display = 'block';
            await loadData();
        } else { alert("Login Gagal!"); }
    }

    function updateSaldoDisplay() {
        document.getElementById('saldo-display').innerText = formatNumber(appData.saldo);
        document.getElementById('modal-saldo-display').innerText = formatNumber(appData.saldo);
    }

    // --- TABS & NAVIGATION ---
    function switchTab(el, tabName) {
        document.querySelectorAll('.nav-item').forEach(i=>i.classList.remove('active'));
        el.classList.add('active');
        document.getElementById('app-container').style.display = 'none';
        document.getElementById('chat-view').style.display = 'none';
        document.querySelector('.fab').style.display = 'none';

        if (tabName === 'posts' || tabName === 'saved' || tabName === 'tagged') {
            document.getElementById('app-container').style.display = 'block';
            document.querySelector('.fab').style.display = 'flex';
            renderFeed();
        } else if (tabName === 'chat') {
            document.getElementById('chat-view').style.display = 'flex';
            renderChat();
        } else if (tabName === 'settings') {
            document.getElementById('app-container').style.display = 'block';
            openSettingsModal();
        }
    }

    // --- CHAT ---
    function renderChat() {
        const container = document.getElementById('chat-messages');
        container.innerHTML = '';
        if (!appData.messages || appData.messages.length === 0) { container.innerHTML = `<div style="text-align:center; color: #555; margin-top: 50px; font-size: 13px;">Belum ada pesan.</div>`; return; }
        appData.messages.forEach(msg => {
            const div = document.createElement('div');
            const isMe = (msg.sender === appData.profile.name);
            div.className = `chat-bubble ${isMe ? 'me' : 'other'}`;
            div.innerHTML = `<span class="chat-sender-name">${msg.sender}</span>${msg.text}<span class="chat-time">${msg.time}</span>`;
            container.appendChild(div);
        });
        container.scrollTop = container.scrollHeight;
    }
    async function sendMessage() {
        const input = document.getElementById('msg-input');
        const text = input.value.trim();
        if (!text) return;
        const now = new Date();
        const timeString = now.getHours().toString().padStart(2,'0') + ':' + now.getMinutes().toString().padStart(2,'0');
        const newMsg = { sender: appData.profile.name, text: text, time: timeString, timestamp: Date.now() };
        appData.messages.push(newMsg);
        input.value = ''; renderChat(); await saveToCloud();
    }
    document.getElementById('msg-input').addEventListener('keypress', function (e) { if (e.key === 'Enter') sendMessage(); });

    // --- SETTINGS, EDIT, UPLOAD, SALDO ---
    function openSettingsModal() { document.getElementById('cloud-bin-id').value = cloudConfig.binId; document.getElementById('cloud-api-key').value = cloudConfig.apiKey; document.getElementById('settings-modal').style.display = 'flex'; }
    function closeSettingsModal() { document.getElementById('settings-modal').style.display = 'none'; }
    async function saveCloudSettings() {
        const id = document.getElementById('cloud-bin-id').value.trim();
        const key = document.getElementById('cloud-api-key').value.trim();
        if(!id || !key) return alert("Kosong!");
        localStorage.setItem('nika_cloud_id', id); localStorage.setItem('nika_cloud_key', key);
        cloudConfig = {binId: id, apiKey: key};
        closeSettingsModal(); await loadData();
    }

    // --- EDIT PROFILE (WITH COMPRESSOR) ---
    function openEditModal() { document.getElementById('edit-name-input').value = appData.profile.name; document.getElementById('edit-bio-input').value = appData.profile.bio; document.getElementById('edit-avatar-preview').src = document.getElementById('main-avatar').src; document.getElementById('edit-modal').style.display = 'flex'; }
    function closeEditModal() { document.getElementById('edit-modal').style.display = 'none'; }
    let tempAvatarBase64 = "";
    
    // PREVIEW DAN COMPRESS AVATAR
    async function previewPP(input) {
        if (input.files && input.files[0]) {
            const file = input.files[0];
            try {
                // Kompres foto PP agar tidak boros storage
                const compressed = await compressImage(file, 300, 0.7); 
                document.getElementById('edit-avatar-preview').src = compressed;
                tempAvatarBase64 = compressed;
            } catch(e) {
                alert("Gagal kompres gambar");
            }
        }
    }

    async function saveProfile() {
        const newName = document.getElementById('edit-name-input').value;
        const newBio = document.getElementById('edit-bio-input').value;
        const newAvatar = tempAvatarBase64 || document.getElementById('edit-avatar-preview').src;
        appData.profile = { name: newName, bio: newBio, avatar: newAvatar };
        document.getElementById('display-name').innerText = newName; document.getElementById('display-bio').innerText = newBio; document.getElementById('main-avatar').src = newAvatar;
        closeEditModal(); await saveToCloud();
    }

    function toggleFileInput() { const t = document.getElementById('type-select').value; document.getElementById('file-input').accept = (t=='photo')?'image/*':(t=='video')?'video/*':'audio/*'; }
    function openUploadModal() { document.getElementById('upload-modal').style.display = 'flex'; }
    function closeUploadModal() { document.getElementById('upload-modal').style.display = 'none'; document.getElementById('file-input').value = ''; document.getElementById('caption-input').value = ''; }
    
    // UPLOAD POST (WITH COMPRESSOR FOR PHOTOS)
    async function uploadPost() {
        const caption = document.getElementById('caption-input').value;
        const type = document.getElementById('type-select').value;
        const file = document.getElementById('file-input').files[0];
        if (!file) return alert("Pilih file!");
        
        try {
            let base64;
            if (type === 'photo') {
                alert("Mengompres foto agar muat di Cloud... Tunggu sebentar.");
                base64 = await compressImage(file, 600, 0.5); // Kompres foto postingan
            } else if (type === 'video') {
                // Video TIDAK bisa dikompres client-side dengan mudah. Harus file kecil.
                // Konversi biasa
                base64 = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = error => reject(error);
                });
                if (base64.length > 1000000) return alert("Video terlalu besar! Gunakan video sangat pendek (<5 detik) atau kualitas rendah.");
            } else {
                // Audio
                base64 = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.readAsDataURL(file);
                    reader.onload = () => resolve(reader.result);
                    reader.onerror = error => reject(error);
                });
            }

            appData.posts.unshift({ id: Date.now(), type, url: base64, caption });
            await saveToCloud();
            renderFeed();
            document.getElementById('post-count').innerText = appData.posts.length;
            closeUploadModal();
        } catch(e) { alert("Gagal! File terlalu besar atau error."); }
    }

    function renderFeed() {
        const c = document.getElementById('feed-container'); c.innerHTML = '';
        if (appData.posts.length === 0) { c.innerHTML = `<div style="width:100%; text-align:center; padding: 60px; color: #555;">Belum ada postingan.</div>`; return; }
        appData.posts.forEach(post => {
            const div = document.createElement('div'); div.className = 'post-card';
            let html = '';
            if(post.type==='photo') html = `<img src="${post.url}" loading="lazy">`;
            else if(post.type==='video') html = `<video src="${post.url}#t=0.1" preload="metadata" muted></video>`;
            else { div.style.aspectRatio='auto'; div.style.height='80px'; div.style.padding='5px'; div.style.display='flex'; div.style.alignItems='center'; div.style.backgroundColor='#1e1e1e'; html = `<div style="color:#888; font-size:12px; flex:1;">üé§ ${post.caption}</div><audio src="${post.url}" controls style="height:30px;"></audio>`; }
            div.innerHTML = html;
            if(post.type!=='voice') { const ov = document.createElement('div'); ov.className='post-overlay'; ov.innerHTML='üëÅÔ∏è'; div.appendChild(ov); }
            div.onclick = () => openViewModal(post);
            c.appendChild(div);
        });
    }

    function openViewModal(p) {
        const m = document.getElementById('view-modal'); const b = document.getElementById('view-media-container');
        m.style.display = 'flex'; document.getElementById('view-caption').innerText = p.caption; b.innerHTML = '';
        if(p.type==='photo') b.innerHTML=`<img src="${p.url}">`;
        else if(p.type==='video') b.innerHTML=`<video src="${p.url}" controls autoplay playsinline></video>`;
        else { b.style.background='#1e1e1e'; b.innerHTML=`<div style="padding:30px; text-align:center;"><h3>üé§ Audio</h3><audio src="${p.url}" controls autoplay style="width:100%; margin-top:20px;"></audio></div>`; }
    }

    function openSaldoModal() { document.getElementById('saldo-modal').style.display = 'flex'; updateSaldoDisplay(); document.getElementById('tarik-jumlah').value=''; document.getElementById('tarik-dana').value=''; document.getElementById('tarik-nama').value=''; document.getElementById('padding-text').style.display='none'; document.getElementById('qr-container').style.display='none'; document.getElementById('btn-tarik-act').style.display='block'; }
    function closeSaldoModal() { document.getElementById('saldo-modal').style.display = 'none'; }
    async function prosesTarik() {
        const j = parseInt(document.getElementById('tarik-jumlah').value);
        const d = document.getElementById('tarik-dana').value;
        const n = document.getElementById('tarik-nama').value;
        if(!j || !d || !n) return alert("Isi semua!");
        if(j > appData.saldo) return alert("Saldo kurang!");
        document.getElementById('btn-tarik-act').style.display='none'; document.getElementById('padding-text').style.display='block';
        setTimeout(() => {
            document.getElementById('padding-text').style.display='none'; document.getElementById('qr-container').style.display='block';
            document.getElementById('qr-image').src=`https://api.qrserver.com/v1/create-qr-code/?size=150x150&data=DANA-${j}-${Date.now()}`;
            setTimeout(async () => {
                appData.saldo -= j; updateSaldoDisplay(); await saveToCloud();
                document.getElementById('qr-container').style.display='none'; document.getElementById('btn-tarik-act').style.display='block';
                closeSaldoModal(); alert(`Sukses kirim Rp ${j.toLocaleString()} ke ${n}`);
            }, 4000);
        }, 2000);
    }

    window.onclick = function(e) {
        if(e.target==document.getElementById('view-modal')) { document.getElementById('view-modal').style.display='none'; document.getElementById('view-modal').querySelector('video')?.pause(); }
        if(e.target==document.getElementById('upload-modal')) closeUploadModal();
        if(e.target==document.getElementById('edit-modal')) closeEditModal();
        if(e.target==document.getElementById('saldo-modal')) closeSaldoModal();
        if(e.target==document.getElementById('settings-modal')) closeSettingsModal();
    }
</script>
</body>
</html>

